[23 <--- ](23.md) [   Зміст   ](README.md) [--> 23.2](23_2.md)

## 23.1 INTRODUCTION

Real-time simulation of multidomain physical system models (mechanical, electrical, hydraulic, etc.) requires finding a combination of model complexity, solver choice, solver settings, and real-time target that permit execution in real time. A better understanding of the trade-offs involved in each of these areas makes it easier to achieve this goal and use Model-Based Design to reap the benefits of using virtual systems before building hardware prototypes. This chapter outlines the steps in moving from desktop to real-time simulation and illustrates this process using models built from MathWorks® products based on Simscape™ simulation technology. The steps described apply to real-time simulation regardless of which real-time hardware is used.

Моделювання в режимі реального часу багатодомних моделей фізичних систем (механічних, електричних, гідравлічних тощо) вимагає пошуку комбінації складності моделі, вибору розв’язувача, налаштувань розв’язувача та цілі в реальному часі, що дозволяє виконувати в реальному часі. Краще розуміння компромісів, пов’язаних із кожною з цих областей, полегшує досягнення цієї мети та використання модельно-орієнтованого проектування, щоб отримати переваги використання віртуальних систем перед створенням прототипів обладнання. У цьому розділі описано етапи переходу від настільного комп’ютера до симуляції в реальному часі та ілюстровано цей процес за допомогою моделей, створених із продуктів MathWorks® на основі технології моделювання Simscape™. Описані кроки застосовуються до симуляції в реальному часі незалежно від того, яке обладнання реального часу використовується.

### 23.1.1 Examples of Real-Time Simulation

Replacing physical devices, such as vehicles, robots, or planes, with virtual devices can drastically reduce the cost of testing control systems, software, and hardware. It can also improve the quality of the final product by enabling more complete testing of the entire system. Often it is necessary to run the computer simulation representing the virtual system in real time. This means that the inputs and outputs (I/O) in the virtual world of simulation must be read or updated synchronously with the physical world. When the simulation time reaches 5, 50, or 500 seconds, the exact same amount of time has passed in the physical world.

Заміна фізичних пристроїв, таких як транспортні засоби, роботів або літаків, на віртуальні може значно знизити вартість тестування систем керування, програмного та апаратного забезпечення. Це також може покращити якість кінцевого продукту, забезпечуючи більш повне тестування всієї системи. Часто необхідно запустити комп'ютерне моделювання, що представляє віртуальну систему в реальному часі. Це означає, що входи та виходи (I/O) у віртуальному світі моделювання повинні читатися або оновлюватися синхронно з фізичним світом. Коли час симуляції досягає 5, 50 або 500 секунд, точнісінько стільки ж часу минуло у фізичному світі.

 ![image-20220823010522452](media/image-20220823010522452.png)

**FIGURE 23.1** SimHydraulics demonstration model of water hammer in a pipeline.

Configuring a model and the numerical integrator to simulate in this manner can be difficult. The simulation execution time per step must be consistent and sufficiently shorter than the time step of the simulation to permit any other tasks that the simulation environment must perform, such as reading sensor inputs or outputting transducer signals. This is a challenging prospect because the conditions vary during simulation. Switches open, valves close, and these occasional events can require more computations to achieve an accurate result. To be successful, the solver settings, simulation step size, and the level of model fidelity must be adjusted to find a combination that permits real-time simulation while delivering accurate results.

Налаштування моделі та числового інтегратора для моделювання таким чином може бути складним. Час виконання моделювання для кожного кроку має бути послідовним і достатньо коротшим за часовий крок моделювання, щоб дозволити будь-які інші завдання, які має виконувати середовище моделювання, наприклад зчитування вхідних даних датчиків або виведення сигналів перетворювача. Це складна перспектива, оскільки умови змінюються під час моделювання. Перемикачі відкриваються, клапани закриваються, і ці випадкові події можуть вимагати додаткових обчислень для досягнення точного результату. Щоб бути успішним, параметри розв’язувача, розмір кроку моделювання та рівень точності моделі повинні бути скориговані, щоб знайти комбінацію, яка дозволяє моделювати в реальному часі, надаючи точні результати.

Advances in solver technology have made it easier to configure simulations to simulate in this fashion. Features added to simulation tools, such as fixed-cost algorithms (algorithms where the computational cost per time step is nearly constant) and local solvers added to Simscape from MathWorks, make it possible to simulate even complex models such as hydraulic pipelines in real time. As an example, we simulated the SimHydraulics® demonstration model sh_segmented_pipeline_test_ rig (Figure 23.1) on a desktop computer using solver ode15s, a maximum step size of 0.03 seconds, and a relative tolerance of 1e-3. After applying the process covered in this chapter to the model, accurate results were achieved when running the model in real time using xPC Target™ [1] from MathWorks on an Intel Core 2 Duo E6700 (2.66 GHz) with a simulation step size of 1 millisecond ([Figure 23.2](#_bookmark141)).

Прогрес у технології вирішувачів полегшив налаштування симуляцій таким чином. Функції, додані до інструментів моделювання, такі як алгоритми з фіксованою вартістю (алгоритми, де обчислювальна вартість за крок у часі майже постійна) і локальні розв’язувачі, додані до Simscape від MathWorks, дають змогу моделювати навіть складні моделі, такі як гідравлічні трубопроводи, у реальному часі. Як приклад, ми змоделювали демонстраційну модель SimHydraulics® sh_segmented_pipeline_test_ rig (Малюнок 23.1) на настільному комп’ютері за допомогою розв’язувача ode15s, максимальний розмір кроку 0,03 секунди та відносний допуск 1e-3. Після застосування процесу, описаного в цьому розділі, до моделі було досягнуто точних результатів під час запуску моделі в режимі реального часу за допомогою xPC Target™ [1] від MathWorks на процесорі Intel Core 2 Duo E6700 (2,66 ГГц) із розміром кроку моделювання 1 мілісекунди ([Малюнок 23.2](#_bookmark141)).

This is a particularly challenging model numerically for it includes the water hammer effect, which takes place when a valve is abruptly opened or closed creating rapid changes in flow rate. Even with the restrictions imposed by executing on a realtime target, the simulation results capture the oscillations in the hydraulic circuit. To develop this process, the steps described in this chapter for moving from desktop to real-time simulation have been applied to this and more than 30 other models in different physical domains built with MathWorks physical modeling products, all of which were able to run in real time.

Це особливо складна модель у чисельному відношенні, оскільки вона включає ефект гідроудару, який виникає, коли клапан різко відкривається або закривається, що призводить до швидких змін у швидкості потоку. Навіть з урахуванням обмежень, накладених виконанням на ціль у реальному часі, результати моделювання фіксують коливання в гідравлічному контурі. Щоб розробити цей процес, кроки, описані в цьому розділі для переходу від настільного комп’ютера до симуляції в реальному часі, було застосовано до цієї та понад 30 інших моделей у різних фізичних областях, створених за допомогою продуктів фізичного моделювання MathWorks, усі з яких можна було запускати в реальний час.

![image-20220823010558631](media/image-20220823010558631.png)

**FIGURE 23.2** Desktop and real-time simulation results. The results are nearly identical.

### 23.1.2 Benefits of Real-Time Simulation

Real-time simulation is used in a number of steps in the development process and in some cases in the final product. In Model-Based Design, the plant model is used to develop and test the control and signal processing algorithms in desktop simulation. Once the designs are complete and the algorithms exist in production code, it is necessary to test that code as well as the production controller. Instead of connecting it directly to a hardware prototype, the plant model used in the design phase can be used to test the production code and processor if it is capable of running in real time. This is referred to as hardware-in-the-loop testing and offers many benefits, including the following:

Моделювання в реальному часі використовується на кількох етапах процесу розробки, а в деяких випадках і в кінцевому продукті. У модельно-орієнтованому проектуванні модель заводу використовується для розробки та тестування алгоритмів керування та обробки сигналів у настільному моделюванні. Після завершення проектування та створення алгоритмів у виробничому коді необхідно протестувати цей код, а також виробничий контролер. Замість підключення безпосередньо до апаратного прототипу, модель заводу, що використовується на етапі проектування, можна використовувати для тестування виробничого коду та процесора, якщо він здатний працювати в режимі реального часу. Це називається тестуванням апаратного забезпечення в циклі та пропонує багато переваг, зокрема:

1. Ability to test conditions that would damage equipment or personnel

2. Ability to test systems where no prototypes exist

3. Reduced costs in the later phases of development

4. Ability to test 24 hours a day, 7 days a week

1. Можливість перевірити умови, які можуть пошкодити обладнання або персонал

2. Можливість тестувати системи, де немає прототипів

3. Зниження витрат на наступних етапах розробки

4. Можливість тестування 24 години на добу, 7 днів на тиждень

In addition to the development process, real-time simulation is also used in the final product. Products that have a human in the simulation loop require real-time simulation. For example, flight simulators that are used to train pilots require real- time simulation of the plane, control system, weather conditions, and other aspects of their environment (see also Chapter 15).

На додаток до процесу розробки, моделювання в реальному часі також використовується в кінцевому продукті. Продукти, у циклі моделювання яких є людина, потребують моделювання в реальному часі. Наприклад, симулятори польотів, які використовуються для навчання пілотів, вимагають моделювання в реальному часі літака, системи керування, погодних умов та інших аспектів навколишнього середовища (див. також Розділ 15).

### 23.1.3 Challenges of Real-Time Simulation

For a simulation to execute in real time, the amount of time spent calculating the solution for a given time step must be less than the duration of that time step. This requires that the execution time per simulation time step be bounded. Variable-step solvers, which are often used in desktop simulation, take smaller steps to accurately capture events that occur during the simulation. However, varying the step size is not an option for real-time simulation, and therefore, a fixed-step solver (implicit or explicit) must be used. This can make real-time simulation more challenging than desktop simulation. The model and fixed-step solvers must be configured so that system dynamics can be accurately captured without changing the step size. These requirements are constraints imposed by hard real-time systems, such as those used to test controller software and hardware. Soft real-time systems, such as video game physics, often have less stringent requirements.

Щоб симуляція виконувалася в режимі реального часу, кількість часу, витраченого на обчислення рішення для даного кроку часу, має бути меншою за тривалість цього кроку часу. Це вимагає, щоб час виконання кожного кроку моделювання був обмежений. Розв’язувачі зі змінним кроком, які часто використовуються в настільному моделюванні, виконують менші кроки, щоб точно фіксувати події, що відбуваються під час моделювання. Однак зміна розміру кроку не є варіантом для моделювання в реальному часі, і тому слід використовувати розв’язувач із фіксованими кроками (явний чи неявний). Це може зробити симуляцію в реальному часі більш складною, ніж симуляція на робочому столі. Модель і вирішувачі з фіксованими кроками повинні бути налаштовані так, щоб динаміку системи можна було точно охопити без зміни розміру кроку. Ці вимоги є обмеженнями, що накладаються системами жорсткого реального часу, такими як ті, що використовуються для тестування програмного та апаратного забезпечення контролера. М’які системи реального часу, такі як фізика відеоігор, часто мають менш суворі вимоги.

A fixed-step solver that provides accurate results at a step size large enough to permit real-time simulation must be chosen. Most fixed-step solvers will produce equally accurate simulation results as a variable-step solver if a small enough step size is chosen. However, different fixed-step solver algorithms (implicit, explicit, lower/higher order, etc.) will require different step sizes to produce accurate results. They also require different amounts of computational effort per time step [2].

Необхідно вибрати розв’язувач із фіксованим кроком, який забезпечує точні результати з розміром кроку, достатньо великим для моделювання в реальному часі. Більшість розв’язувачів із фіксованим кроком дадуть однаково точні результати моделювання, як і розв’язувач зі змінним кроком, якщо вибрано достатньо малий розмір кроку. Однак різні алгоритми розв’язувача з фіксованими кроками (явні, явні, нижчого/вищого порядку тощо) вимагатимуть різних розмірів кроків для отримання точних результатів. Вони також вимагають різної кількості обчислювальних зусиль на кожен крок [2].

Once a solver is chosen, determining an appropriate step size is the next challenge. Increasing the time step to permit more time to calculate the result can lead to inaccurate results. Reducing the time step to improve the accuracy of the simulation results may make it impossible to execute in real time. Trial and error may be required to find the combination of settings that permit real-time simulation while producing accurate simulation results. The eigenvalues [3] of the system can give an indication of the time constants in the system and help determine what the required minimum step size is.

Після вибору розв’язувача наступним завданням є визначення відповідного розміру кроку. Збільшення кроку за часом, щоб дати більше часу для обчислення результату, може призвести до неточних результатів. Зменшення кроку за часом для підвищення точності результатів моделювання може зробити неможливим виконання в реальному часі. Може знадобитися метод проб і помилок, щоб знайти комбінацію налаштувань, яка дозволить симулювати в реальному часі, одержуючи точні результати моделювання. Власні значення [3] системи можуть дати вказівку на постійні часу в системі та допомогти визначити необхідний мінімальний розмір кроку.

If this combination of settings cannot be found, it may be that the model contains effects that a fixed-step solver cannot handle at a step size that permits real- time simulation. These effects can be events in the simulation (hard stops, stick-slip friction, switches that open and close, etc.) or portions of the system that have a very small time constant (small masses attached to stiff springs, current or pressure oscillations, etc.). Identifying and modifying these elements is then required before searching for the combination of solver settings and step size that will permit real- time simulation.

Якщо цю комбінацію налаштувань знайти неможливо, можливо, модель містить ефекти, які розв’язувач із фіксованими кроками не може впоратися з розміром кроку, який дозволяє симуляцію в реальному часі. Ці наслідки можуть бути подіями в симуляції (різкі зупинки, тертя стрибків-ковзань, перемикачі, які відкриваються та закриваються тощо) або частинами системи, які мають дуже малу постійну часу (малі маси, прикріплені до жорстких пружин, коливання струму чи тиску тощо). Ідентифікувати та модифікувати ці елементи необхідно перед тим, як шукати комбінацію налаштувань розв’язувача та розмір кроку, які дозволять симулювати в реальному часі.

Section 23.2 will cover the process of configuring a model used in desktop simulation for real-time simulation. The process involves determining if the model is built at an appropriate level of fidelity for real-time simulation, simplifying if necessary, and configuring solver settings to achieve accurate results.

У розділі 23.2 буде розглянуто процес налаштування моделі, що використовується в симуляції робочого столу для моделювання в реальному часі. Процес передбачає визначення того, чи модель побудована на належному рівні точності для моделювання в реальному часі, спрощення, якщо необхідно, і налаштування параметрів розв’язувача для отримання точних результатів.

[23 <--- ](23.md) [   Зміст   ](README.md) [--> 23.2](23_2.md)