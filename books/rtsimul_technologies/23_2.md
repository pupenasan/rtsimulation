[23.1 <--- ](23_1.md) [   Зміст   ](README.md) [--> 23.3](23_3.md)

**23.1**            **MOVING** **FROM** **DESKTOP** **TO** **REAL-TIME** **SIMULATION**

To move from desktop simulation to real-time simulation on the chosen real-time hardware, the following items must be adjusted until the simulation can execute in real time and deliver results sufficiently close to the results obtained from desktop simulation:

 

\1.   Solver choice

\2.   Number of solver iterations

\3.   Step size

\4.   Model size and fidelity

 

The procedure depicted in the flowchart in Figure 23.3 shows how to configure a model for real-time simulation.

This process has been applied to over 30 models containing hydraulic, electrical, mechanical, pneumatic, and thermal components that include a range of linear and

​                                                                                                                                   

​            6 Adjust model to make it      real-time capable            

​            1      Obtain reference      results and estimate step size with variable-step solver            

​            Y            

​            2 Is the solver taking too many      small steps?      N      Simulate with            

​            3            

​            fixed-step, fixed-cost solver            

​            N            

​            New results match reference results?      Y             Acceptable simulation            

​            Increase iterations and/or decrease step size            

​            N            

​            4            

​            Decrease iterations and/or increase step size            

​            N            

​            speed?            

​            N            

​            Y            

​            5            

​            real-time platform            

​            Simulate on            

​            N            

​            Executes      in real time with accurate results?            

​            Y    Success            







**FIGURE 23.3** Flowchart depicting the process that helps engineers move from desktop simulation to real-time simulation.



**586**                             Real-Time Simulation Technologies

 

nonlinear elements. In each case, real-time execution was achieved with very accu- rate results. The modeling concepts in these models included the following:

 

\1.   Combined multibody (3D-mechanical) and hydraulic or electrical systems

\2.   Dynamic, compressible fluid flow (hydraulic and pneumatic)

\3.   Physical phenomena (friction and clutch events)

\4.   Hybrid models (continuous-time plants plus discrete logic control systems)

\5.   Multirate systems (multiple sample rates within the model)

 

**23.1.1**             **p****RoCEduRE foR** **T****uning** **s****olvER** **s****ETTings**

*Step 1: Obtain a converged set of results with a variable-step solver*.

To ensure that the results obtained with the fixed-step solver are accurate, a set of reference results are needed. These can be obtained by simulating the system with a variable-step solver and ensuring that the results are converged by tightening the error tolerances until the simulation results do not change. For Simscape models, the recommended variable-step solvers are ode15s and ode23t.

 

*Step 2: Examine the step sizes during the simulation to determine if the model is likely to run with a large enough step size to permit real-time simulation*.

A variable-step solver will vary the step size to stay within the error tolerances and to react to zero-crossing events [4]. If the solver abruptly reduces the step size to a small value (e.g., 1e-15s), this indicates that the solver is attempting to accurately identify a zero-crossing event. A fixed-step solver may have trouble capturing these events at a step size that is sufficiently large to permit real-time simulation.

The following MATLAB® commands can be used to generate a plot that shows how the time step varies during the simulation:

 

semilogy(tout(1:end-1),diff(tout),‘-*’); title(‘Step Size vs. Simulation Time’,‘FontSize’,14,‘FontWeight’,‘bold’); xlabel(‘Simulation Time (s)’,‘FontSize’,12); ylabel(‘Step Size (s)’,‘FontSize’,12);

 

The plots in [Figures 23.4 ](#_bookmark142)and 23.5 illustrate the concepts explained above. They are produced by executing the preceding MATLAB code on the simulation results from the SimHydraulics model shown in [Figures 23.6 ](#_bookmark143)and 23.7, which contains a number of components that create zero-crossing events.

This analysis should provide a rough idea of a step size that can be used to run the simulation. Determining what effects are causing these events and modifying or eliminating them will make it easier to run the system with a fixed-step solver at a larger step size and produce results comparable to the variable-step simulation.

 

*Step 3: Simulate the system with a fixed-step, fixed-cost solver and compare the results to the reference set of results obtained from the variable-step simulation*.

As explained in Section 23.1.3, a fixed-step solver (implicit or explicit) must be used to run the simulation in real time. The chosen solver must provide robust performance and



Real-Time Simulation of Physical Systems Using Simscape™              **587**



 

 

   10–2

 

10–4

 

​     ![Підпис: Step size (seconds)](file:///C:/Users/OLEKSA~1/AppData/Local/Temp/msohtmlclip1/01/clip_image008.png)10–6

 

10–8

 

10–10

 

10–12





**Step size versus simulation time**



 

10–14 0     0.2    0.4    0.6    0.8     1     1.2    1.4    1.6    1.8     2

Simulation time (seconds)

**FIGURE 23.4** Plot of step size during variable-step simulation. Abrupt drops in step size indicate zero-crossing events. The amount of zero-crossing events and how easily the simu- lation recovers give a rough indication of how difficult it will be for a fixed-step solver to produce accurate results at the largest step size the variable-step solver uses.

   **Step size versus simulation time**

10–4

 

10–6                                  1

 

​     ![Підпис: Step size (seconds)](file:///C:/Users/OLEKSA~1/AppData/Local/Temp/msohtmlclip1/01/clip_image010.png)10–8

 

 

10–10

 

10–12           2                                               3

 

10–14 1.5166 1.5167 1.5168 1.5169 1.517 1.5171 1.5172 1.5173

Simulation time (seconds)

**FIGURE 23.5** Plot of a smaller range of the step size during simulation. (1) indicates the step size that will meet the error tolerances for most of the simulation. (2) are examples of zero-crossing events where the solver recovered instantly and may not be difficult for the fixed-step solver. (3) are examples of zero-crossing events where the variable-step solver took longer to recover and will likely require a smaller step size for the fixed-step solver to deliver results with acceptable accuracy.



**588**                             Real-Time Simulation Technologies

​     

**FIGURE 23.6** Hydraulic model of a pipeline system modeled in SimHydraulics containing valves, junctions, and a centrifugal pump.

​     

**FIGURE 23.7** Portion of SimHydraulics model containing directional valves, flow control valves, and orifices.

 

deliver accurate results at a step size large enough to permit real-time simulation. The solver should be chosen to minimize the amount of computation required per time step while providing robust performance at the largest step size possible. To decide which type of fixed-step solver to use, it is necessary to determine if the model describes a stiff or a nonstiff problem. The problem is stiff if the solution the solver is seeking var- ies slowly, but there are other solutions within the error tolerances that vary rapidly [2].

Comparing the simulation results generated by a fixed-step implicit solver and a fixed-step explicit solver for the same model of a pneumatic system ([Figure 23.8](#_bookmark144)) shows a difference in accuracy that is dependent on step size ([Figure 23.9](#_bookmark144)) and model stiffness ([Figure 23.10](#_bookmark145)).



Real-Time Simulation of Physical Systems Using Simscape™              **589**

​     

**FIGURE 23.8** Pneumatic system containing a pump, valve, and motor, simulated using implicit and explicit fixed-step solvers.

 

 

 

 

​            

​                Variable step, implicit     Fixed-step implicit, Ts = 1e–3 seconds Fixed-step explicit, Ts = 1e–3 seconds Fixed-step     explicit, Ts =     5e–4 seconds          



**Accuracy of implicit and explicit** **xed-step solvers**



 

0.5

 

0.4

 

​     ![Підпис: Flow rate](file:///C:/Users/OLEKSA~1/AppData/Local/Temp/msohtmlclip1/01/clip_image015.png)0.3

 

0.2

 

0.1

 

0

 

5.03      5.035      5.04       5.045      5.05      5.055      5.06

Time (seconds)

**FIGURE 23.9** Plot showing simulation results for the same model simulated with a variable-step solver, fixed-step implicit solver, and fixed-step explicit solver. The explicit solver requires a smaller time step to achieve accuracy comparable to the implicit solver.



**590**                             Real-Time Simulation Technologies

 

**Accuracy of implicit and explicit** **xed-step solvers**

​            

​          Variable step, implicit     Fixed-step implicit, Ts = 1e–3 seconds Fixed-step explicit, Ts = 1e–3 seconds Fixed-step explicit, Ts = 5e–4 seconds          



10



 

 

​     ![Підпис: Revolutions per minute](file:///C:/Users/OLEKSA~1/AppData/Local/Temp/msohtmlclip1/01/clip_image017.png)5

 

0

 

 

–5

 



–10

0.37     0.375      0.38      0.385

Time (seconds)





0.39      0.395       0.4



 

**FIGURE 23.10** Plot showing simulation results for the same model simulated with a variable-step solver, fixed-step implicit solver, and fixed-step explicit solver. The oscillations in the fixed-step explicit solver simulation results suggest this is a stiff problem.

 

Explicit and implicit solvers use different numerical methods to solve the system of equations. An explicit algorithm samples the local gradient to find a solution, whereas an implicit algorithm uses matrix operations to solve a system of simulta- neous equations that helps predict the evolution of the solution [2]. As a result, an implicit algorithm does more work per simulation step but can take larger steps. For stiff systems, implicit solvers should be used.

Both accuracy and computational effort must be taken into account when choos- ing a fixed-step solver. Simulating physical systems often involves multiple iterations per time step to converge on a solution. For a real-time simulation, the amount of computational effort per time step must be bounded. To have a bounded amount of execution time per simulation time step, it is necessary to limit the number of itera- tions per time step. This is known as a fixed-cost simulation. Fixed-cost simulation is used to prevent overruns, which occur when the execution time is longer than the sample time. [Figure 23.11 ](#_bookmark146)shows how an overrun can occur if the number of itera- tions is not limited.

Iterations are necessary with implicit solvers. The iterations are handled auto- matically with variable-step solvers, but for the implicit fixed-step solver ode14x in Simulink®, the number of iterations per time step must be set. This is controlled by the parameter “Number Newton’s iterations” in the Solver pane of the Configuration Parameters dialog box in Simulink.

Iterations are also often necessary for each Simscape physical network for both explicit and implicit solvers. The iterations in Simscape are limited by setting the checkbox, “Use fixed-cost runtime consistency iterations” and entering the number of nonlinear iterations in the Solver Configuration block (see [Figure 23.12](#_bookmark146)). If the local solver option is used, it is recommended to initially set the number of nonlinear iterations to two or three.



Real-Time Simulation of Physical Systems Using Simscape™              **591**

 

 

 

 

 

 

​            

​          Iteration     1          

​          Iteration     2          

​          Iteration     3          

​          True     solution          



​    

![Підпис: Solution](file:///C:/Users/OLEKSA~1/AppData/Local/Temp/msohtmlclip1/01/clip_image019.png)Simulation time





   Time required to calculate solution per iteration.



Simulation overrun because too many iterations are required.



 

 

Real time

**FIGURE 23.11** A fixed-step solver keeps the time step constant. Limiting any needed itera- tions per time step is necessary for fixed-cost simulation.

 

**Solver** **configuration**

​                  

​            ***f\*** **(*****x\*****)** **=** **0**            

​            Use fixed-cost runtime consistency iterations            

​            Nonlinear iterations            

​            2            







**FIGURE 23.12** In Simscape, the Solver Configuration block permits limitation of the itera- tions per time step.

 

The amount of computational effort required by a solver varies with respect to a number of factors, including model complexity. To provide an indication of the rela- tive cost for the fixed-step solvers available, a nonlinear model of a pneumatic actua- tion system (shown in [Figure 23.8](#_bookmark144)) containing a single Simscape physical network was simulated with each of the fixed-step solvers. These simulations were conducted at the same step size with similar settings for the total number of solver iterations. [Figure 23.13 ](#_bookmark147)shows the normalized execution time.

From this plot, it is clear that for this example, most explicit fixed-step solv- ers require less computational effort than the implicit fixed-step solver ode14x. Although an explicit solver may require less computational effort, for stiff prob- lems, an implicit solver is necessary for accurate results. For this example, the two local Simscape solvers (Backward Euler and Trapezoidal Rule) required the least computational effort. In most cases, they provide the best combination of speed and accuracy.



**592**                             Real-Time Simulation Technologies

 



 

3.5

 

​     ![Підпис: Normalized cost (relative to ODE1)](file:///C:/Users/OLEKSA~1/AppData/Local/Temp/msohtmlclip1/01/clip_image022.png)3



**Normalized cost of** **xed-step solvers**



 

​            

​          Explicit Implicit     Implicit, Simscape only          



2.5



 

2

 

1.5

 

1

 

0.5

 



0

ODE1 ODE2 ODE3 ODE4 ODE5 ODE8 ODE14x BE





Trap



BE = Backward Euler Trap = Trapezoidal Rule

**FIGURE 23.13** Plot of the normalized cost of all fixed-step solvers that can be used on Simscape models. The results were obtained by simulating a nonlinear model containing a single Simscape physical network with each solver at the same step size and similar settings for the total number of solver iterations.

 

A powerful option available in Simscape is to use a local solver on physical net- works [5] . By using this option, it is possible to use an implicit fixed-step solver only on the stiff portions of the model and an explicit fixed-step solver on the remainder of the model ([Figure 23.14](#_bookmark148)). This minimizes the computations performed per time step, making it more likely the model will run in real time.

For Simscape models, the Backward Euler and the Trapezoidal Rule should always be tested and will most likely provide the best performance and the most flexibil- ity because they can be configured per physical network. [Figure 23.15 ](#_bookmark148)shows how to enable the local solver and the settings associated with it. The Backward Euler solver is designed to be robust and tends to damp out oscillations. The Trapezoidal Rule solver is designed to be more accurate and preserve oscillations. The Backward Euler algo- rithm tends to be less accurate than the Trapezoidal Rule but more numerically stable.

To summarize recommendations for setting up fixed-cost simulations:

 

\1.   If the system is nonstiff and is described by ordinary differential equations (ODEs), an explicit solver is usually the best choice.

\2.   If the system is stiff, an implicit solver (ode14x, Backward Euler, or Trapezoidal Rule) should be used and the number of iterations must be limited.

\3.   For Simscape models:

a.   Performing a fixed-cost simulation requires setting the number of itera- tions to prevent overruns. This is done by selecting the “Use fixed-cost



Real-Time Simulation of Physical Systems Using Simscape™              **593**



Fixed-step explicit solver

Controller





Local fixed-step implicit solver no. 1

 

   Simscape physical network

 

Simscape physical network

Local fixed-step implicit solver no. 2



 

**FIGURE 23.14** Using local solvers permits configuring implicit solvers on the stiff portions of the model and explicit solvers on the remainder of the model, minimizing execution time while maintaining accuracy.

 

**Solver** **configuration**

​                  

​            ***f\*** **(*****x\*****)** **=** **0**            

​            Use local solver             Solver type             Backward Euler            

​            Sample time            

​            .001            







 

**FIGURE 23.15** In Simscape, the Solver Configuration block permits configuration of local solvers on Simscape physical networks.

 

runtime consistency iterations” setting in the Solver Configuration block attached to the Simscape physical network.

b.   The local solvers in Simscape should always be tested. Using a local solver is often the best choice for fixed-cost simulations.

c.   When performing fixed-cost simulation using the local solvers in Simscape, it is recommended to initially set the number of nonlinear iterations to two or three.

d.   If you are using ode14x on a model with a Simscape physical network, to perform a fixed-cost simulation, it is necessary to enable fixed cost and set the number of nonlinear iterations in the Solver Configuration block.



**594**                             Real-Time Simulation Technologies

 

*Step 4: Find the combination of step size and number of nonlinear iterations where the step size is small enough to produce results that are sufficiently close to the set of reference results obtained from variable-step simulation and large enough so that there is enough safety margin to prevent an overrun*.

During each time step, the real-time system must calculate the simulation results for the next time step (simulation execution) and read the inputs and write the outputs (processing I/O and other tasks). If this takes less than the specified time step, the processor remains idle during the remainder of the step. These quantities are illus- trated in Figure 23.16.

The challenge is to find appropriate settings that provide accurate results while permitting real-time simulation. In each case, it is a trade-off of accuracy versus speed. Choosing a computationally intensive solver, increasing the number of non- linear iterations, or reducing the step size both increases the accuracy and reduces the amount of idle time, raising the risk that the simulation will not run in real time. Adjusting these settings in the opposite direction will increase the amount of idle time but reduce accuracy.

It is necessary to leave sufficient safety margin to avoid an overrun when simulat- ing in real time. If the amount of time spent processing inputs, outputs, and other tasks as well as the desired percentage of idle time are known, the amount of time available for simulation execution can be calculated as follows:

Simulation Execution Budget = Step Size − (Processing Input/Output Time +

Desired Percentage Idle Time × Step Size)

Estimating the budget for the execution time helps ensure a feasible combination of settings is chosen.

 

​                  

​            Maximum possible step size      Larger step sizes result in poor      accuracy and robustness Affected by solver choice and number of nonlinear iterations      Chosen step size             Minimum possible step size Smaller      step sizes result in overrun      Execution time                      Safety margin      Affected by solver choice and                 Affected by      number of nonlinear iterations                  step size            

​            Simulation execution            

​            Processing I/O and other tasks            

​            Idle            







Step size

**FIGURE 23.16** Trade-off involving solver choice, number of nonlinear iterations, and step size. For a given model, these must be chosen to deliver maximum accuracy and robustness with enough idle time to provide a sufficient safety margin.



Real-Time Simulation of Physical Systems Using Simscape™              **595**

 

The speed of simulation on the desktop can be used to estimate the execution time on the real-time target. There are many factors that affect the execution time on the real-time target, and therefore, simply comparing processor speed may not be sufficient. A better method is to measure the execution time during desktop simula- tion and then to determine the average execution time per time step on the real-time target for a given model. Knowing how these values relate for one model makes it possible to estimate execution time on the real-time target from the execution time during desktop simulation when testing other models.

 

*Step 5: Using the selected solver, number of nonlinear iterations, and step size, sim- ulate on the real-time platform and determine if the simulation can run in real time*. The tests run on the real-time platform should cover a representative set of tests to ensure that the worst-case scenario for the idle time is captured. This may include varying parameter values, inputs, and a range of conditions for the external hardware (reading/writing the I/O). The model needs to be robust enough to handle all situa- tions that it may encounter.

 

*Step 6: If the simulation does not run in real time on the selected real-time platform, it will be necessary to determine the cause and choose an appropriate solution*.

If the simulation does not run in real time on the real-time platform, it may be due to the fact that the model is not real-time capable. The combination of effects captured in the model and the speed of the real-time platform may make it impossible to find solver settings that will permit it to run in real time (Figure 23.17).

If the simulation is not real-time capable, there are some options that can be explored:

 

\1.   Use a faster real-time computer.

\2.   Determine new settings that reduce the execution time (e.g., reducing the number of nonlinear iterations) or permit a larger step size.

 



 

Maximum possible step size A ected by sharp events

and systems with small time constants

 

Minimum possible step size Smaller step sizes result in overrun

Execution time

A ected by model size, model complexity, and speed of real-time platform

 

Simulation execution

 

Step size



Model is not real-time capable because the minimum possible step size permitting

   real-time execution is larger than the maximum possible step size that permits acceptable accuracy and robustness

 

 

 

 

 

Processing I/O and other tasks



**FIGURE 23.17** Diagram showing when a simulation is not real-time capable. The minimum possible step size permitting real-time execution is larger than the maximum possible step size that permits acceptable accuracy and robustness.



**596**                             Real-Time Simulation Technologies

 

\3.   Eliminate effects that require significant computational effort or that require a small time step to accurately capture them.

\4.   If possible, configure the model and the real-time system to evaluate the physical networks in parallel. This can be done if for a given time step the networks are not dependent on one another. Experience with the generated code and the real-time target is required to use this option.

 

**23.1.2**              **a****djusTing** **m****odEls** **To** **m****akE** **T****hEm** **R****Eal****-T****imE** **C****apaBlE**

In the event that no settings can be found that permit the simulation to run in real time on the available real-time computer while delivering accurate results, it is necessary to modify or remove effects from the model that prevent real-time simulation. Here are two categories and some examples.

\1.   Elements that create events

In this case, an event occurs so that the solution changes nearly instanta- neously. The rapid change can be difficult for a fixed-step solver to step over and find the correct solution on the other side of the event. If it fails to find the solution, the solver may go unstable. Examples of elements that create these kinds of events include the following:

a.   Hard stops, backlash

b.   Stick-slip friction

c.   Switches or clutches

\2.   Elements with a small time constant

In this case, an element or a group of elements has a very small time con- stant as compared to the desired simulation step size. These elements create fast dynamics that require a small step size so that a fixed-step solver can accurately capture the dynamics. Examples of systems that have a small time constant include the following:

a.   Small masses attached to stiff springs with minimal damping

b.   Electrical circuits with fast dynamics

c.   Hydraulic circuits with small compressible volumes

If a scripting environment that has commands permitting interrogation of the model, such as MATLAB, is available, identifying these components and param- eters can be done very quickly, which narrows the search for the effects that must be modified. There are methods to automate these searches using tools such as the Simulink Model Advisor that makes it easier to apply these searches to other models. Examining the eigenmodes of the system can indicate which states have the high- est frequency, and mapping those states to the individual components may point to the source of the problem. For nonlinear models, this can only be done at an indi- vidual operating point and that operating point can be identified by looking for small

step sizes during a variable-step simulation.

Once the effects have been identified, the next step is to modify or eliminate them. Methods that can be used to modify these effects include the following:

\1.   Replacing nonlinear component models with linearized versions of those models

\2.    Using lookup tables to simplify complex equations



Real-Time Simulation of Physical Systems Using Simscape™              **597**

 

\3.   Producing a simplified model by using system identification theory on the I/O data

\4.   Smoothing discontinuous functions (step changes) by using filters and other techniques.

Once the model is modified, the process described in Section 23.2 can be applied to identify the appropriate solver configuration and settings to enable real-time simulation.

[23.1 <--- ](23_1.md) [   Зміст   ](README.md) [--> 23.3](23_3.md)